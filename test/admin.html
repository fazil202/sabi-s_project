<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Exam Management System</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="/static/admin.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('dashboard') }}">
          <i class="fas fa-chair"></i> Exam Seating System
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('dashboard') }}">
                <i class="fas fa-tachometer-alt"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('generate_plan') }}">
                <i class="fas fa-plus"></i> Generate Plan
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('pdf_history') }}">
                <i class="fas fa-history"></i> History
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="{{ url_for('admin_panel') }}">
                <i class="fas fa-cogs"></i> Admin Panel
              </a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="fas fa-user"></i> {{ session.full_name }}
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="{{ url_for('settings') }}">
                    <i class="fas fa-cog"></i> Settings
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Logout
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <!-- Flash Messages -->
      {% with messages = get_flashed_messages() %} {% if messages %} {% for
      message in messages %}
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      {% endfor %} {% endif %} {% endwith %}

      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
          <div class="card">
            <div class="card-header bg-dark text-white">
              <h5 class="mb-0"><i class="fas fa-tools"></i> Admin Tools</h5>
            </div>
            <div class="list-group list-group-flush">
              <a
                href="#overview"
                class="list-group-item list-group-item-action active"
                data-bs-toggle="tab"
              >
                <i class="fas fa-chart-bar"></i> Overview
              </a>
              <a
                href="#users"
                class="list-group-item list-group-item-action"
                data-bs-toggle="tab"
              >
                <i class="fas fa-users"></i> User Management
              </a>
              <a
                href="#activity"
                class="list-group-item list-group-item-action"
                data-bs-toggle="tab"
              >
                <i class="fas fa-clipboard-list"></i> Activity Logs
              </a>
              <a
                href="#system"
                class="list-group-item list-group-item-action"
                data-bs-toggle="tab"
              >
                <i class="fas fa-server"></i> System Health
              </a>
              <a
                href="{{ url_for('settings') }}"
                class="list-group-item list-group-item-action"
              >
                <i class="fas fa-cog"></i> System Settings
              </a>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
          <div class="tab-content">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview">
              <div class="card">
                <div class="card-header">
                  <h4 class="mb-0">
                    <i class="fas fa-chart-bar"></i> System Overview
                  </h4>
                </div>
                <div class="card-body">
                  <!-- Statistics Cards -->
                  <div class="row mb-4">
                    <div class="col-md-3">
                      <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                          <div class="display-6">
                            <i class="fas fa-users"></i>
                          </div>
                          <h3 class="mt-2">{{ users|length }}</h3>
                          <p class="mb-0">Total Users</p>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="card bg-success text-white">
                        <div class="card-body text-center">
                          <div class="display-6">
                            <i class="fas fa-user-check"></i>
                          </div>
                          <h3 class="mt-2">
                            {{ users|selectattr('is_active')|list|length }}
                          </h3>
                          <p class="mb-0">Active Users</p>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                          <div class="display-6">
                            <i class="fas fa-chalkboard-teacher"></i>
                          </div>
                          <h3 class="mt-2">
                            {{ users|selectattr('role', 'equalto',
                            'faculty')|list|length }}
                          </h3>
                          <p class="mb-0">Faculty</p>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="card bg-info text-white">
                        <div class="card-body text-center">
                          <div class="display-6">
                            <i class="fas fa-graduation-cap"></i>
                          </div>
                          <h3 class="mt-2">
                            {{ users|selectattr('role', 'equalto',
                            'student')|list|length }}
                          </h3>
                          <p class="mb-0">Students</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Quick Actions -->
                  <div class="row">
                    <div class="col-md-6">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                          <div class="d-grid gap-2">
                            <a
                              href="{{ url_for('manage_users') }}"
                              class="btn btn-outline-primary"
                            >
                              <i class="fas fa-users-cog"></i> Manage Users
                            </a>
                            <a
                              href="{{ url_for('settings') }}"
                              class="btn btn-outline-info"
                            >
                              <i class="fas fa-cog"></i> System Settings
                            </a>
                            <button
                              class="btn btn-outline-warning"
                              onclick="refreshSystemStats()"
                            >
                              <i class="fas fa-sync"></i> Refresh Stats
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">System Status</h5>
                        </div>
                        <div class="card-body">
                          <div class="row text-center">
                            <div class="col-4">
                              <div class="text-success">
                                <i class="fas fa-database fa-2x"></i>
                                <div><small>Database</small></div>
                                <div>
                                  <small class="text-success">Online</small>
                                </div>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="text-success">
                                <i class="fas fa-server fa-2x"></i>
                                <div><small>Server</small></div>
                                <div>
                                  <small class="text-success">Running</small>
                                </div>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="text-warning">
                                <i class="fas fa-envelope fa-2x"></i>
                                <div><small>Email</small></div>
                                <div>
                                  <small class="text-warning">Configure</small>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Users Tab -->
            <div class="tab-pane fade" id="users">
              <div class="card">
                <div
                  class="card-header d-flex justify-content-between align-items-center"
                >
                  <h4 class="mb-0">
                    <i class="fas fa-users"></i> User Management
                  </h4>
                  <a
                    href="{{ url_for('manage_users') }}"
                    class="btn btn-primary"
                  >
                    <i class="fas fa-plus"></i> Manage Users
                  </a>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Username</th>
                          <th>Full Name</th>
                          <th>Email</th>
                          <th>Role</th>
                          <th>Status</th>
                          <th>Created</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for user in users[:10] %}
                        <tr>
                          <td>{{ user.username }}</td>
                          <td>{{ user.full_name }}</td>
                          <td>{{ user.email }}</td>
                          <td>
                            <span
                              class="badge {% if user.role == 'admin' %}bg-danger {% elif user.role == 'faculty' %}bg-warning {% else %}bg-info{% endif %}"
                            >
                              {{ user.role.title() }}
                            </span>
                          </td>
                          <td>
                            <span
                              class="badge {% if user.is_active %}bg-success{% else %}bg-secondary{% endif %}"
                            >
                              {% if user.is_active %}Active{% else %}Inactive{%
                              endif %}
                            </span>
                          </td>
                          <td>
                            {{ user.created_at.strftime('%Y-%m-%d') if
                            user.created_at else 'N/A' }}
                          </td>
                          <td>
                            <div class="btn-group btn-group-sm">
                              <button
                                class="btn btn-outline-primary btn-sm"
                                onclick="editUser('{{ user.id }}')"
                              >
                                <i class="fas fa-edit"></i>
                              </button>
                              {% if user.id != session.user_id %}
                              <button
                                class="btn btn-outline-danger btn-sm"
                                onclick="toggleUser('{{ user.id }}')"
                              >
                                <i class="fas fa-ban"></i>
                              </button>
                              {% endif %}
                            </div>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% if users|length > 10 %}
                  <div class="text-center">
                    <a
                      href="{{ url_for('manage_users') }}"
                      class="btn btn-outline-primary"
                    >
                      View All {{ users|length }} Users
                    </a>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Activity Logs Tab -->
            <div class="tab-pane fade" id="activity">
              <div class="card">
                <div class="card-header">
                  <h4 class="mb-0">
                    <i class="fas fa-clipboard-list"></i> Recent Activity Logs
                  </h4>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Time</th>
                          <th>User</th>
                          <th>Action</th>
                          <th>Details</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for log in recent_logs %}
                        <tr>
                          <td class="text-nowrap">
                            {{ log.created_at.strftime('%Y-%m-%d %H:%M') if
                            log.created_at else 'N/A' }}
                          </td>
                          <td>{{ log.username or 'System' }}</td>
                          <td>
                            <span
                              class="badge {% if 'LOGIN' in log.action %}bg-success {% elif 'FAILED' in log.action %}bg-danger {% elif 'PDF' in log.action %}bg-info {% else %}bg-secondary{% endif %}"
                            >
                              {{ log.action.replace('_', ' ').title() }}
                            </span>
                          </td>
                          <td class="text-truncate truncate-td">
                            {{ log.details or 'No details available' }}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- System Health Tab -->
            <div class="tab-pane fade" id="system">
              <div class="card">
                <div class="card-header">
                  <h4 class="mb-0">
                    <i class="fas fa-server"></i> System Health & Monitoring
                  </h4>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="card bg-light">
                        <div class="card-header">
                          <h5 class="mb-0">
                            <i class="fas fa-chart-line"></i> System Metrics
                          </h5>
                        </div>
                        <div class="card-body">
                          <div class="row text-center">
                            <div class="col-6 mb-3">
                              <div class="border-end">
                                <h4 class="text-primary">{{ users|length }}</h4>
                                <small>Total Users</small>
                              </div>
                            </div>
                            <div class="col-6 mb-3">
                              <h4 class="text-success">24/7</h4>
                              <small>Uptime</small>
                            </div>
                            <div class="col-6">
                              <div class="border-end">
                                <h4 class="text-info">
                                  {{ recent_logs|length }}
                                </h4>
                                <small>Recent Activities</small>
                              </div>
                            </div>
                            <div class="col-6">
                              <h4 class="text-warning">0</h4>
                              <small>System Errors</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card bg-light">
                        <div class="card-header">
                          <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle"></i> System
                            Alerts
                          </h5>
                        </div>
                        <div class="card-body">
                          <div class="alert alert-info mb-2">
                            <i class="fas fa-info-circle"></i>
                            System is running normally
                          </div>
                          <div class="alert alert-warning mb-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            Email configuration needs setup
                          </div>
                          <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle"></i>
                            Database connection stable
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Performance Monitoring -->
                  <div class="card mt-3">
                    <div class="card-header">
                      <h5 class="mb-0">
                        <i class="fas fa-tachometer-alt"></i> Performance
                        Monitoring
                      </h5>
                    </div>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-4 text-center">
                          <div class="progress mb-2 progress-20">
                            <div
                              class="progress-bar bg-success"
                              role="progressbar"
                              class="progress-bar-85"
                              aria-valuenow="85"
                              aria-valuemin="0"
                              aria-valuemax="100"
                            >
                              85%
                            </div>
                          </div>
                          <small>Server Performance</small>
                        </div>
                        <div class="col-md-4 text-center">
                          <div class="progress mb-2 progress-20">
                            <div
                              class="progress-bar bg-info"
                              role="progressbar"
                              class="progress-bar-92"
                              aria-valuenow="92"
                              aria-valuemin="0"
                              aria-valuemax="100"
                            >
                              92%
                            </div>
                          </div>
                          <small>Database Performance</small>
                        </div>
                        <div class="col-md-4 text-center">
                          <div class="progress mb-2 progress-20">
                            <div
                              class="progress-bar bg-warning"
                              role="progressbar"
                              class="progress-bar-45"
                              aria-valuenow="45"
                              aria-valuemin="0"
                              aria-valuemax="100"
                            >
                              45%
                            </div>
                          </div>
                          <small>Storage Usage</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function refreshSystemStats() {
        // Refresh system statistics
        location.reload();
      }

      function editUser(userId) {
        // Redirect to user management page with edit mode
        window.location.href = "{{ url_for('manage_users') }}?edit=" + userId;
      }

      function toggleUser(userId) {
        if (confirm("Are you sure you want to toggle this user's status?")) {
          // Implement user status toggle
          console.log("Toggle user:", userId);
        }
      }

      // Auto-refresh activity logs every 30 seconds
      setInterval(function () {
        if (document.querySelector("#activity.active")) {
          // Only refresh if activity tab is active
          fetch("/api/activity_logs?limit=20")
            .then((response) => response.json())
            .then((data) => {
              // Update activity logs table
              console.log("Activity logs refreshed");
            })
            .catch((error) => console.error("Error:", error));
        }
      }, 30000);
    </script>
  </body>
</html>
