<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF History - Exam Seating Plan Generator</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      .bg-gradient-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      }

      .history-container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .stat-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-2px);
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
      }

      .stat-label {
        color: #666;
        margin-top: 5px;
      }

      .btn-download {
        background-color: #28a745;
        color: white;
        text-decoration: none;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .btn-download:hover {
        background-color: #218838;
        color: white;
        text-decoration: none;
      }

      .email-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .email-modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 400px;
        max-width: 90%;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover {
        color: black;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
      }

      .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('dashboard') }}">
          <i class="fas fa-chair"></i> Exam Seating System
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('dashboard') }}">
                <i class="fas fa-tachometer-alt"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('generate_plan') }}">
                <i class="fas fa-plus"></i> Generate Plan
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="{{ url_for('pdf_history') }}">
                <i class="fas fa-history"></i> History
              </a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="fas fa-user"></i> {{ session.full_name }}
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="{{ url_for('settings') }}">
                    <i class="fas fa-cog"></i> Settings
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Logout
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- Flash Messages -->
      {% with messages = get_flashed_messages() %} {% if messages %} {% for
      message in messages %}
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      {% endfor %} {% endif %} {% endwith %}

      <!-- Welcome Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card bg-gradient-primary text-white">
            <div class="card-body">
              <h2 class="card-title" style="color: black">
                <i class="fas fa-history"></i>
                PDF History
              </h2>
              <p class="card-text" style="color: black">
                View and manage your previously generated seating plans
              </p>
              <p class="mb-0">Access downloads and send email notifications</p>
            </div>
          </div>
        </div>
      </div>

      <div class="history-container">
        <!-- Statistics Cards -->
        <div class="row mb-4">
          <div class="col-md-4 mb-3">
            <div class="card stat-card h-100">
              <div class="card-body text-center">
                <div class="display-6 text-primary mb-3">
                  <i class="fas fa-file-pdf"></i>
                </div>
                <h3 class="stat-number">{{ pdf_history|length }}</h3>
                <p class="stat-label mb-0">Total PDFs</p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card stat-card h-100">
              <div class="card-body text-center">
                <div class="display-6 text-success mb-3">
                  <i class="fas fa-graduation-cap"></i>
                </div>
                <h3 class="stat-number">{{ total_students }}</h3>
                <p class="stat-label mb-0">Total Students</p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card stat-card h-100">
              <div class="card-body text-center">
                <div class="display-6 text-warning mb-3">
                  <i class="fas fa-door-open"></i>
                </div>
                <h3 class="stat-number">{{ total_rooms }}</h3>
                <p class="stat-label mb-0">Total Rooms</p>
              </div>
            </div>
          </div>
        </div>

        <!-- History Table -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-table"></i> Generated Seating Plans
                </h5>
              </div>
              <div class="card-body p-0">
                {% if pdf_history %}
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th><i class="fas fa-calendar"></i> Date Created</th>
                        <th><i class="fas fa-file"></i> Filename</th>
                        <th><i class="fas fa-users"></i> Students</th>
                        <th><i class="fas fa-door-closed"></i> Rooms</th>
                        <th><i class="fas fa-chair"></i> Per Desk</th>
                        <th><i class="fas fa-building"></i> Building</th>
                        <th><i class="fas fa-cogs"></i> Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for pdf in pdf_history %}
                      <tr>
                        <td>
                          <small class="text-muted">
                            {{ pdf.created_at.strftime('%Y-%m-%d') if
                            pdf.created_at else 'N/A' }}<br />
                            {{ pdf.created_at.strftime('%H:%M') if
                            pdf.created_at else '' }}
                          </small>
                        </td>
                        <td>
                          <span class="badge bg-light text-dark"
                            >{{ pdf.filename }}</span
                          >
                        </td>
                        <td>
                          <span class="badge bg-primary"
                            >{{ pdf.student_count }}</span
                          >
                        </td>
                        <td>
                          <span class="badge bg-success"
                            >{{ pdf.room_count }}</span
                          >
                        </td>
                        <td>
                          <span class="badge bg-info"
                            >{{ pdf.students_per_desk }}</span
                          >
                        </td>
                        <td>
                          <small class="text-muted">{{ pdf.building }}</small>
                        </td>
                        <td>
                          <div class="btn-group" role="group">
                            <a
                              href="{{ url_for('download_history_pdf', pdf_id=pdf.id) }}"
                              class="btn btn-sm btn-success"
                              title="Download PDF"
                            >
                              <i class="fas fa-download"></i>
                            </a>
                            <button
                              type="button"
                              class="btn btn-sm btn-info"
                              onclick="openEmailModal('{{ pdf.id }}')"
                              title="Send Email"
                            >
                              <i class="fas fa-envelope"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                  <div class="display-1 text-muted mb-3">
                    <i class="fas fa-file-pdf"></i>
                  </div>
                  <h4 class="text-muted">No PDF history found</h4>
                  <p class="text-muted">
                    You haven't generated any seating plans yet.
                  </p>
                  <a
                    href="{{ url_for('generate_plan') }}"
                    class="btn btn-primary"
                  >
                    <i class="fas fa-plus"></i> Generate Your First Plan
                  </a>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        {% if pdf_history %}
        <div class="row mt-4">
          <div class="col-md-6 mb-3">
            <div class="card h-100 text-center">
              <div class="card-body">
                <div class="display-4 text-primary mb-3">
                  <i class="fas fa-plus-circle"></i>
                </div>
                <h5 class="card-title">Generate New Plan</h5>
                <p class="card-text">Create another seating arrangement</p>
                <a
                  href="{{ url_for('generate_plan') }}"
                  class="btn btn-primary"
                >
                  <i class="fas fa-arrow-right"></i> Start Now
                </a>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="card h-100 text-center">
              <div class="card-body">
                <div class="display-4 text-info mb-3">
                  <i class="fas fa-tachometer-alt"></i>
                </div>
                <h5 class="card-title">Back to Dashboard</h5>
                <p class="card-text">Return to main dashboard</p>
                <a href="{{ url_for('dashboard') }}" class="btn btn-info">
                  <i class="fas fa-home"></i> Dashboard
                </a>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="email-modal">
      <div class="email-modal-content">
        <span class="close" onclick="closeEmailModal()">&times;</span>
        <h3><i class="fas fa-envelope"></i> Send Email Notifications</h3>
        <form
          id="emailForm"
          method="POST"
          action="{{ url_for('send_email_notifications') }}"
        >
          <input type="hidden" id="pdfId" name="pdf_id" value="" />
          <div class="form-group">
            <label for="recipientType">
              <i class="fas fa-users"></i> Send to:
            </label>
            <select
              id="recipientType"
              name="recipient_type"
              required
              class="form-select"
            >
              <option value="">Select recipients...</option>
              <option value="students">
                <i class="fas fa-graduation-cap"></i> Students Only
              </option>
              <option value="faculty">
                <i class="fas fa-chalkboard-teacher"></i> Faculty Only
              </option>
              <option value="both">
                <i class="fas fa-users"></i> Both Students and Faculty
              </option>
            </select>
          </div>
          <div class="text-end">
            <button
              type="button"
              class="btn btn-secondary me-2"
              onclick="closeEmailModal()"
            >
              <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane"></i> Send Email
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      function openEmailModal(pdfId) {
        document.getElementById("pdfId").value = pdfId;
        document.getElementById("emailModal").style.display = "block";
      }

      function closeEmailModal() {
        document.getElementById("emailModal").style.display = "none";
        document.getElementById("recipientType").value = "";
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        var modal = document.getElementById("emailModal");
        if (event.target == modal) {
          closeEmailModal();
        }
      };

      // Add keyboard support for modal
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeEmailModal();
        }
      });
    </script>
  </body>
</html>
